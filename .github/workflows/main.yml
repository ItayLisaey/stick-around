name: Build

on:
    push:
        branches: [next]
    pull_request:
        branches: [next]

    # Allows you to run this workflow manually from the Actions tab
    workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
    # This workflow contains a single job called "build"
    capacitor-build:
        # The type of runner that the job will run on
        runs-on: ubuntu-latest
        # Steps represent a sequence of tasks that will be executed as part of the job
        steps:
            - uses: actions/checkout@v2
            - uses: actions/setup-node@v2
              with:
                  node-version: '14'
            - run: npm install
            - run: npm test
            - run: npm run build
            - run: npx cap sync
            - run: sudo npx cap copy android && cd android && chmod +x gradlew && ./gradlew bundleRelease
            - name: upload to google play
              uses: r0adkll/upload-google-play@v1
              with:
                  serviceAccountJsonPlainText: ${{ secrets.SERVICE_ACCOUNT_JSON }}
                  packageName: com.stickaround.app
                  releaseFiles: android/app/build/outputs/bundle/release/*.aab
                  track: beta
                  inAppUpdatePriority: 0
                  whatsNewDirectory: distribution/whatsnew
                  mappingFile: android/app/build/outputs/mapping/release/mapping.txt
